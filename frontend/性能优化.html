<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能优化 | Jinle Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="this is my blog">
    <meta name="author" content="Jinle">
    <meta name="keywords" content="Jinle，博客">
    
    <link rel="preload" href="/blog/assets/css/0.styles.6a057b61.css" as="style"><link rel="preload" href="/blog/assets/js/app.bfa839b2.js" as="script"><link rel="preload" href="/blog/assets/js/2.645db33a.js" as="script"><link rel="preload" href="/blog/assets/js/21.f4d465d2.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.9c8a1f5b.js"><link rel="prefetch" href="/blog/assets/js/11.c298643d.js"><link rel="prefetch" href="/blog/assets/js/12.427a10fc.js"><link rel="prefetch" href="/blog/assets/js/13.be77fcd1.js"><link rel="prefetch" href="/blog/assets/js/14.f37c6f32.js"><link rel="prefetch" href="/blog/assets/js/15.d0c9f0d9.js"><link rel="prefetch" href="/blog/assets/js/16.29bd1750.js"><link rel="prefetch" href="/blog/assets/js/17.23b38649.js"><link rel="prefetch" href="/blog/assets/js/18.8f6226ec.js"><link rel="prefetch" href="/blog/assets/js/19.f5f11d8b.js"><link rel="prefetch" href="/blog/assets/js/20.cb070a76.js"><link rel="prefetch" href="/blog/assets/js/22.d2749c0c.js"><link rel="prefetch" href="/blog/assets/js/23.87c08510.js"><link rel="prefetch" href="/blog/assets/js/24.8b11f7a9.js"><link rel="prefetch" href="/blog/assets/js/25.9400e42a.js"><link rel="prefetch" href="/blog/assets/js/26.052c5410.js"><link rel="prefetch" href="/blog/assets/js/27.567369c3.js"><link rel="prefetch" href="/blog/assets/js/3.7d8e4f36.js"><link rel="prefetch" href="/blog/assets/js/4.ac928f4c.js"><link rel="prefetch" href="/blog/assets/js/5.3bee8350.js"><link rel="prefetch" href="/blog/assets/js/6.80fd9f1e.js"><link rel="prefetch" href="/blog/assets/js/7.76822249.js"><link rel="prefetch" href="/blog/assets/js/8.02e5baef.js"><link rel="prefetch" href="/blog/assets/js/9.eb5fc156.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.6a057b61.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Jinle Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="https://jinle0703.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  随笔
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/JINLE0703/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="https://jinle0703.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  随笔
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/JINLE0703/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/blog/frontend/" aria-current="page" class="sidebar-link">HTML</a></li><li><a href="/blog/frontend/CSS.html" class="sidebar-link">CSS</a></li><li><a href="/blog/frontend/JavaScript.html" class="sidebar-link">JavaScript</a></li><li><a href="/blog/frontend/React.html" class="sidebar-link">React</a></li><li><a href="/blog/frontend/React相关库.html" class="sidebar-link">React相关库</a></li><li><a href="/blog/frontend/Vue.html" class="sidebar-link">Vue</a></li><li><a href="/blog/frontend/TypeScript.html" class="sidebar-link">TypeScript</a></li><li><a href="/blog/frontend/Node.html" class="sidebar-link">Node</a></li><li><a href="/blog/frontend/Koa.html" class="sidebar-link">Koa</a></li><li><a href="/blog/frontend/微信小程序.html" class="sidebar-link">微信小程序</a></li><li><a href="/blog/frontend/浏览器相关.html" class="sidebar-link">浏览器相关</a></li><li><a href="/blog/frontend/前端工程化.html" class="sidebar-link">前端工程化</a></li><li><a href="/blog/frontend/计算机网络.html" class="sidebar-link">计算机网络</a></li><li><a href="/blog/frontend/前端安全.html" class="sidebar-link">前端安全</a></li><li><a href="/blog/frontend/性能优化.html" class="active sidebar-link">性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#性能优化" class="sidebar-link">性能优化</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#rail模型" class="sidebar-link">RAIL模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#response" class="sidebar-link">Response</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#animation" class="sidebar-link">Animation</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#idle" class="sidebar-link">Idle</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#load" class="sidebar-link">Load</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#渲染优化" class="sidebar-link">渲染优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#重排-回流" class="sidebar-link">重排/回流</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#优化" class="sidebar-link" style="padding-left:3rem;">优化</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#布局抖动" class="sidebar-link">布局抖动</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#优化-2" class="sidebar-link" style="padding-left:3rem;">优化</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#重绘" class="sidebar-link">重绘</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#requestanimationframe" class="sidebar-link">requestAnimationFrame</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#contain" class="sidebar-link">contain</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#资源加载优化" class="sidebar-link">资源加载优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#图片懒加载" class="sidebar-link">图片懒加载</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#字体优化" class="sidebar-link">字体优化</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#font-display" class="sidebar-link" style="padding-left:3rem;">font-display</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#预加载" class="sidebar-link">预加载</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#preload" class="sidebar-link" style="padding-left:3rem;">preload</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#prefetch" class="sidebar-link" style="padding-left:3rem;">prefetch</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#常用-api" class="sidebar-link">常用 API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#时间节点" class="sidebar-link">时间节点</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#观察长任务" class="sidebar-link">观察长任务</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#页面可见性" class="sidebar-link">页面可见性</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#网络状态" class="sidebar-link">网络状态</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#性能测试工具" class="sidebar-link">性能测试工具</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/性能优化.html#webpagetest-本地部署" class="sidebar-link">WebPageTest 本地部署</a></li></ul></li><li><a href="/blog/frontend/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/blog/frontend/数据结构.html" class="sidebar-link">数据结构</a></li><li><a href="/blog/frontend/算法.html" class="sidebar-link">算法</a></li><li><a href="/blog/frontend/WebSocket.html" class="sidebar-link">WebSocket</a></li><li><a href="/blog/frontend/操作系统.html" class="sidebar-link">操作系统</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="性能优化"><a href="#性能优化" class="header-anchor">#</a> 性能优化</h2> <ul><li>资源传输优化
<ul><li>启用 Gzip 压缩</li> <li>启用 Keep-Alive 长连接</li> <li>使用 HTTP 资源缓存</li> <li>使用 Service Worker （离线缓存）</li> <li>使用服务端渲染（SSR）</li> <li>设置资源预加载（<code>preload</code> or <code>prefetch</code>）</li></ul></li> <li>资源优化
<ul><li>图片懒加载（原生 or 第三方库）</li> <li>图片格式化</li> <li>字体优化（<code>font-display</code>）</li> <li>图标优化（IconFont or svg）</li></ul></li> <li>渲染优化
<ul><li>避免重排重绘</li> <li>代码分割，读写分离</li> <li>路由懒加载</li></ul></li> <li>CSS 优化
<ul><li>不用 table 布局，改用 flexbox 布局</li> <li>使用 <code>transform</code></li> <li>频繁操作 DOM，可以先将 DOM 离线（<code>display: none</code>）</li></ul></li> <li>JS 优化
<ul><li>函数防抖、节流</li></ul></li></ul> <h2 id="rail模型"><a href="#rail模型" class="header-anchor">#</a> RAIL模型</h2> <p>RAIL 是一个以用户为中心的性能模型，它把用户的体验拆分成几个关键点，并且定义好了每一个的性能指标</p> <p>有以下四方面：</p> <ul><li><strong>Response —— 事件处理最好在 50ms 内完成</strong></li> <li><strong>Animation —— 在 10ms 内产生一帧</strong></li> <li><strong>Idle —— 最大化空闲时间</strong></li> <li><strong>Load —— 传输内容到页面可交互的时间不超过 5 秒</strong></li></ul> <h3 id="response"><a href="#response" class="header-anchor">#</a> Response</h3> <h5 id="目标"><a href="#目标" class="header-anchor">#</a> 目标</h5> <ul><li>用户的输入到响应的时间不超过 100ms，给用户的感受是瞬间就完成</li></ul> <h5 id="优化方案"><a href="#优化方案" class="header-anchor">#</a> 优化方案</h5> <ul><li>事件处理函数在 50ms 内完成，考虑到 idle task 的情况，事件会排队，等待时间大概在 50ms</li> <li>复杂的 js 计算尽可能放在后台，如 web worker，避免对用户输入造成阻塞</li> <li>超过50ms的响应，一定要提供反馈，比如倒计时，进度百分比等</li></ul> <blockquote><p>idle task：除了要处理输入事件，浏览器还有其它任务要做，这些任务会占用部分时间，一般情况会花费 50ms 的时间，输入事件的响应则排在其后</p></blockquote> <p><img src="https://raw.githubusercontent.com/jinle0703/img-host/master/blog/idleTask%E7%A4%BA%E6%84%8F%E5%9B%BE" alt="Idle Task示意图"></p> <h3 id="animation"><a href="#animation" class="header-anchor">#</a> Animation</h3> <h5 id="目标-2"><a href="#目标-2" class="header-anchor">#</a> 目标</h5> <ul><li>产生每一帧的时间不要超过 10ms，为了保证浏览器 60 帧，每一帧的时间在 16ms 左右，但浏览器需要用 6ms 来渲染每一帧</li></ul> <h5 id="优化方案-2"><a href="#优化方案-2" class="header-anchor">#</a> 优化方案</h5> <h3 id="idle"><a href="#idle" class="header-anchor">#</a> Idle</h3> <h5 id="目标-3"><a href="#目标-3" class="header-anchor">#</a> 目标</h5> <ul><li>最大化空闲时间，以增大 50ms 内响应用户输入的几率</li></ul> <h5 id="优化方案-3"><a href="#优化方案-3" class="header-anchor">#</a> 优化方案</h5> <ul><li>用空闲时间来完成一些延后的工作，如先加载页面可见的部分，然后利用空闲时间加载剩余部分</li> <li>在空闲时间内执行的任务尽量控制在 50ms 以内</li> <li>如果用户在空闲时间任务进行时进行交互，必须以此为最高优先级，并暂停空闲时间的任务</li></ul> <h3 id="load"><a href="#load" class="header-anchor">#</a> Load</h3> <h5 id="目标-4"><a href="#目标-4" class="header-anchor">#</a> 目标</h5> <ul><li>优化加载速度，可以根据设备、网络等条件。目前，比较好的一个方式是，让页面在一个中配的 3G 网络手机上打开时间不超过 5 秒</li> <li>对于第二次打开，尽量不超过 2 秒</li></ul> <h5 id="优化方案-4"><a href="#优化方案-4" class="header-anchor">#</a> 优化方案</h5> <ul><li>在手机设备上测试加载性能，选用中配的 3G 网络（400kb/s，400ms RTT），可以使用 <strong>WebPageTest</strong> 来测试</li> <li>禁用渲染阻塞的资源，延后加载</li> <li>让第一次加载的资源更少</li></ul> <h2 id="渲染优化"><a href="#渲染优化" class="header-anchor">#</a> 渲染优化</h2> <h3 id="重排-回流"><a href="#重排-回流" class="header-anchor">#</a> 重排/回流</h3> <p>重排也就是回流，对性能开销比较大，一般是元素的几何位置发生变化，浏览器触发重新布局</p> <p>以下操作会触发回流：</p> <ul><li>页面初次渲染（开销最大）</li> <li>添加、删除可见 DOM 元素</li> <li>移动元素位置</li> <li>改变元素尺寸，比如边距、填充、边框、宽度和高度等</li> <li>改变元素内容，比如文字数量，图片大小等</li> <li>改变元素字体大小</li> <li>改变浏览器窗口尺寸</li> <li>激活CSS伪类（例如：<code>:hover</code>）</li> <li>设置 style 属性的值</li> <li>获取 offsetTop、scrollTop、clientTop 等（浏览器需要重新计算）</li></ul> <h4 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h4> <ul><li><strong>样式集中改变</strong> <ul><li>静态页面尽量更改类名而不是样式</li> <li>动态页面尽量统一更改</li></ul></li> <li><strong>分离读写操作</strong></li> <li><strong>将 DOM 离线</strong> <ul><li><code>display: none</code> 会触发一次重排，可将其设置后进行变更操作后，再设置 <code>display</code> 属性</li> <li><code>documentFragment</code> 创建一个 DOM 碎片进行批量操作</li> <li>复制节点后变更再替换原本节点</li></ul></li> <li><strong>脱离文档流</strong> <ul><li>使用 <code>absolute | fixed</code> 会使的该元素单独成为渲染树中 <code>body</code> 的一个子元素，重排开销比较小</li></ul></li> <li><strong>优化动画</strong></li></ul> <h3 id="布局抖动"><a href="#布局抖动" class="header-anchor">#</a> 布局抖动</h3> <p>当我们的代码执行一系列连续的读取和写入 DOM 时会发生布局抖动，迫使浏览器重新计算布局信息，造成 Web 应用程序产生更慢、更少的响应</p> <h4 id="优化-2"><a href="#优化-2" class="header-anchor">#</a> 优化</h4> <ul><li>读写分离，批量的读取和写入，如 <a href="https://github.com/wilsonpage/fastdom" target="_blank" rel="noopener noreferrer">fastdom<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>避免回流，可以用 tarnsform-translate 来做位移</li></ul> <h3 id="重绘"><a href="#重绘" class="header-anchor">#</a> 重绘</h3> <p>修改了元素的背景颜色等外观属性，不引发布局阶段直接进入绘制阶段就是重绘</p> <h3 id="requestanimationframe"><a href="#requestanimationframe" class="header-anchor">#</a> requestAnimationFrame</h3> <p>requestAnimationFrame 是浏览器用于定时循环操作的一个接口，类似于 setTimeout，主要用途是按帧对网页进行重绘</p> <p>requestAnimationFrame 最大的优势是 <strong>由系统来决定回调函数的执行时机，它能保证回调函数在屏幕每一次的刷新间隔中只被执行一次（在触发重新布局前）</strong></p> <p>requestAnimationFrame 还能 <strong>节约 CPU 资源</strong>，一旦页面不处于浏览器的当前标签，就会自动停止刷新</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 动画操作</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="contain"><a href="#contain" class="header-anchor">#</a> contain</h3> <p>利用 <code>contain：layout</code>，与浏览器进行沟通，设置当前元素和它的内容尽可能独立于 DOM 树的其他部分</p> <p>这使得浏览器在重新计算布局、样式、绘图、大小或这四项的组合时，只影响到有限的 DOM 区域，而不是整个页面，可以有效改善性能</p> <p>比如：有一个 <code>ul</code> 列表里面显示着倒序的数据，如果对第一个 <code>li</code> 插入内容会触发列表重新渲染，如果使用 <code>contain</code> 属性插入操作就只改变被修改 <code>li</code> ，不影响其它元素</p> <h2 id="资源加载优化"><a href="#资源加载优化" class="header-anchor">#</a> 资源加载优化</h2> <h3 id="图片懒加载"><a href="#图片懒加载" class="header-anchor">#</a> 图片懒加载</h3> <p>原生 <code>img</code> 标签已经支持懒加载，添加 <code>loading='lazy'</code> 属性即可</p> <p>推荐使用第三方懒加载库，拓展性和兼容性会更好</p> <h3 id="字体优化"><a href="#字体优化" class="header-anchor">#</a> 字体优化</h3> <p>CSS 开始支持 <code>@font-face</code> 这个指令后，可以加载自定义的字体文件，用户在浏览网站的时候，会下载 <code>@font-face</code> 中指定的字体</p> <p>浏览器加载 Web Fonts 按顺序有三个时期：</p> <ol><li><strong>阻塞期（Block Period）</strong> —— 在此期间如果字体没有加载完成，那么浏览器会使用 <code>font-family</code> 指定的字体列表中的后备字体（Fallback）进行渲染，但是显示为空白，也就是对于用户是不可见的。在此期间字体加载完成之后才能正常显示该字体</li> <li><strong>交换期（Swap Period）</strong> —— 跟阻塞期类似，但是在这个时期内，它会在字体加载时，先用后备字体渲染文本并显示出来（而不是显示空白），在此期间字体加载完成之后才能正常的显示该字体</li> <li><strong>失败期（Failure Period）</strong> —— 如果字体加载失败，则使用后备字体显示文本</li></ol> <p>每个时期的时长是由 <code>font-display</code> 决定的</p> <h4 id="font-display"><a href="#font-display" class="header-anchor">#</a> font-display</h4> <p><code>font-display</code> 确切的说不是 CSS 属性，而是专用于 <code>@font-face</code> 指令的描述符，它可以取如下几个值：</p> <ul><li><code>auto</code>  —— 这个是 <code>font-display</code> 的默认值，字体的加载过程由浏览器自行决定，不过基本上和取值为 <code>block</code> 时的处理方式一致</li> <li><code>block</code> —— 在字体加载前，会使用备用字体渲染，但是显示为空白，使得它一直处于阻塞期，当字体加载完成之后，进入交换期，用下载下来的字体进行文本渲染。不过有些浏览器并不会无限的处于阻塞期，会有超时限制，<strong>一般在 3s 后，如果阻塞期仍然没有加载完字体，那么直接就进入交换期，显示后备字体（而非空白），等字体下载完成之后直接替换</strong></li> <li><code>swap</code> —— 基本上没有阻塞期，直接进入交换期，<strong>使用后备字体渲染文本，等用到的字体加载完成之后替换掉后备字体</strong></li> <li><code>fallback</code> —— 阻塞期很短（大约 100ms），也就是说会有大约 <strong>100ms 的显示空白的后备字体</strong>，然后交换期也有时限（大约 3s ），在这段时间内 <strong>如果字体加载成功了就会替换成该字体，如果没有加载成功那么后续会一直使用后备字体渲染文本</strong></li> <li><code>optional</code> —— 阻塞期很短（大约 100ms），但是没有交换期，**如果在阻塞期的 100ms 内字体加载完成，那么会使用该字体，否则直接使用后备字体。**这个就是说指定的网络字体是可有可无的，如果加载很快那么可以显示，加载稍微慢一点就不会显示了，适合网络情况不好的时候，例如移动网络</li></ul> <p><strong>使用 <code>swap</code> 属性可以有效减少用户看不见字体的时间</strong></p> <h3 id="预加载"><a href="#预加载" class="header-anchor">#</a> 预加载</h3> <h4 id="preload"><a href="#preload" class="header-anchor">#</a> preload</h4> <p>提前加载较晚出现，但对当前页面非常重要的资源</p> <p>不像 prefetch 有可能被浏览器忽略，浏览器必须请求 preload 标记的资源</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="prefetch"><a href="#prefetch" class="header-anchor">#</a> prefetch</h4> <p>如果我们确定某个资源将来一定会被使用到，我们可以让浏览器预先请求该资源并放入浏览器缓存中</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prefetch<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>**预获取对 webfonts 性能提升非常明显。**目前，字体文件必须等到 DOM 和 CSS 构建完成之后才开始下载，使用预获取就可以轻松绕过该瓶颈</p> <h2 id="常用-api"><a href="#常用-api" class="header-anchor">#</a> 常用 API</h2> <h3 id="时间节点"><a href="#时间节点" class="header-anchor">#</a> 时间节点</h3> <p><code>performance.getEntriesByType('navigation')[0]</code> 可以获取一个有关时间节点的对象</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 获取首次可交互时间</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Time to Interactive 可交互时间</span>
    <span class="token keyword">let</span> timing <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">'navigation'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>timing<span class="token punctuation">.</span>domInteractive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diff <span class="token operator">=</span> timing<span class="token punctuation">.</span>domInteractive <span class="token operator">-</span> timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;TTI: &quot;</span> <span class="token operator">+</span> diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>DNS 解析耗时 —— domainLookupEnd - domainLookupStart</li> <li>TCP 连接耗时 —— connectEnd - connectStart</li> <li>SSL 安全连接耗时 —— connectEnd - secureConnectionStart</li> <li>网络请求耗时（TTFB） —— responseStart - requestStart</li> <li>数据传输耗时 —— responseEnd - responseStart</li> <li>DOM 解析耗时 —— domInteractive - responseEnd</li> <li>资源加载耗时 —— loadEventStart - domContentLoadedEventEnd</li> <li>First Byte 时间 —— responseStart - domainLookupStart</li> <li>白屏时间 —— responseEnd - fetchStart</li> <li>首次可交互时间 —— domInteractive - fetchStart</li> <li>DOM Ready 时间 —— domContentLoadEventEnd - fetchStart</li> <li>页面完全加载时间 —— loadEventStart - fetchStart</li> <li>http 头部大小 —— transferSize - encodedBodySize</li> <li>重定向次数 —— performance.navigation.redirectCount</li> <li>重定向耗时 —— redirectEnd - redirectStart</li></ul> <h3 id="观察长任务"><a href="#观察长任务" class="header-anchor">#</a> 观察长任务</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 观察长任务</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>entryTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'longtask'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="页面可见性"><a href="#页面可见性" class="header-anchor">#</a> 页面可见性</h3> <p>监听 <code>visibilitychange</code> 事件可以监控页面的可见性（显示 or 隐藏）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 见面可见性的状态监听</span>
<span class="token keyword">let</span> vEvent <span class="token operator">=</span> <span class="token string">'visibilitychange'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>webkitHidden <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// webkit 事件名称</span>
    vEvent <span class="token operator">=</span> <span class="token string">'webkitvisibilitychange'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">visibilityChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>hidden <span class="token operator">||</span> document<span class="token punctuation">.</span>webkitHidden<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Web page is hidden.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Web page is visible.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>vEvent<span class="token punctuation">,</span> visibilityChanged<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="网络状态"><a href="#网络状态" class="header-anchor">#</a> 网络状态</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 获取网络状态</span>
<span class="token keyword">let</span> connection <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection <span class="token operator">||</span> navigator<span class="token punctuation">.</span>mozConnection <span class="token operator">||</span> navigator<span class="token punctuation">.</span>webkitConnection<span class="token punctuation">;</span>
<span class="token keyword">let</span> type <span class="token operator">=</span> connection<span class="token punctuation">.</span>effectiveType<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">updateConnectionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Connection type changed from &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; to &quot;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span>effectiveType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  type <span class="token operator">=</span> connection<span class="token punctuation">.</span>effectiveType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

connection<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> updateConnectionStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="性能测试工具"><a href="#性能测试工具" class="header-anchor">#</a> 性能测试工具</h2> <ul><li>WebPageTest</li> <li>Chrome lightHouse</li> <li>Chrome DevTools</li></ul> <h2 id="webpagetest-本地部署"><a href="#webpagetest-本地部署" class="header-anchor">#</a> WebPageTest 本地部署</h2> <ol><li><p>拉取镜像</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker pull webpagetest/server

docker pull webpagetest/agent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>运行实例</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -d -p 4000:80 --rm webpagetest/server

docker run -d -p 4001:80 --network=&quot;host&quot; -e &quot;SERVER_URL=http://localhost:4000/work/&quot; -e &quot;LOCATION=Test&quot; webpagetest/agent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/JINLE0703/blog/edit/main/docs/frontend/性能优化.md" target="_blank" rel="noopener noreferrer">edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2021/3/24 上午9:09:41</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/frontend/前端安全.html" class="prev">
        前端安全
      </a></span> <span class="next"><a href="/blog/frontend/设计模式.html">
        设计模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.bfa839b2.js" defer></script><script src="/blog/assets/js/2.645db33a.js" defer></script><script src="/blog/assets/js/21.f4d465d2.js" defer></script>
  </body>
</html>
